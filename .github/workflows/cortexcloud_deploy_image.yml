name: Container Image Scan with CortexCLI

on:
  workflow_dispatch:
    inputs:
      container_image:
        description: 'Example: ghcr.io/myorg/webapp:1.0 or chrisley75/nginx:latest'
        required: true

jobs:
  build-and-scan:
    runs-on: ubuntu-latest

    env:
      CORTEX_API_URL: ${{ vars.CORTEX_API_URL }}
      CORTEX_API_KEY: ${{ secrets.CORTEX_API_KEY }}
      CORTEX_API_KEY_ID: ${{ secrets.CORTEX_API_KEY_ID }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Pull image
        shell: bash
        run: |
          echo "üîπ Pulling image: ${{ github.event.inputs.container_image }}"
          docker pull ${{ github.event.inputs.container_image }}

      - name: Install dependencies
        shell: bash
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq xz-utils libhyperscan-dev libhyperscan5

      - name: Download and Install CortexCLI
        shell: bash
        run: |
          echo "Downloading CortexCLI..."
          mkdir -p cortexcli
          curl -s -o cortexcli/cortexcli $(curl -s "${CORTEX_API_URL}/public_api/v1/unified-cli/releases/download-link?os=linux&architecture=amd64" \
            -H "x-xdr-auth-id: ${CORTEX_API_KEY_ID}" \
            -H "Authorization: ${CORTEX_API_KEY}" | jq -r ".signed_url")
          chmod +x cortexcli/cortexcli
          sudo mv cortexcli/cortexcli /usr/local/bin/
          cortexcli --version

      - name: check image
        shell: bash
        run: |
          docker images  

      - name: Scan image with CortexCLI
        shell: bash
        run: |
          echo "üîç Scanning image..."
          cortexcli --log-level DEBUG --api-base-url $CORTEX_API_URL \
                    --api-key $CORTEX_API_KEY \
                    --api-key-id $CORTEX_API_KEY_ID \
                    image scan --timeout 300 \
                    ${{ github.event.inputs.container_image }}